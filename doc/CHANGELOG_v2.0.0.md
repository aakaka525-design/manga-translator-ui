# v2.0.0 更新日志

发布日期：2024-12-24

## ✨ 新功能

### PSD 导出
- 支持导出分图层的 PSD 文件（原图、修复图、文字层）
- 文字层包含字体、大小、颜色等完整属性，可直接在 Photoshop 中编辑
- 支持保留竖排/横排格式和縦中横特性

### 离线翻译模式（用户组权限）
- 新增 `allow_offline_translation` 权限，可在用户或用户组级别配置
- 启用后，用户上传图片进行批量翻译时，即使关闭浏览器或断开连接，任务也会在服务器后台继续执行
- 翻译完成后结果自动保存到历史记录中
- 适用于大批量翻译场景，无需保持在线等待

### 编辑器文本框样式增强
- 支持设置文本框描边颜色
- 支持设置文本框描边宽度
- 支持设置文本行间距
- 提供更精细的文本排版控制

### 编辑器未翻译图片支持
- 未翻译的图片现在可以像普通图片一样进行编辑
- 支持在未翻译图片上手动绘制蒙版
- 绘制蒙版后自动触发图片修复功能
- 适用于手动处理未经翻译的原图场景

### HEIC 格式支持
- 新增对 HEIC/HEIF 图片格式的支持
- 可直接上传和处理 iPhone 拍摄的 HEIC 格式图片

## 🐛 修复

### 智能缩放模式方向不匹配检测
- 新增方向不匹配检测功能：当自动检测为竖排但被强制设置为横排（或反之）时，自动打开换行避免文本溢出
- 适用于智能缩放模式，确保强制方向设置时文本能正确排版
- 编辑器同步支持此功能

### Strict 模式 AI 断句适配
- Strict 模式现已完全支持 AI 断句功能
- 当 AI 断句开启且有 BR 标记时，使用无限宽度/高度让文本按 AI 断句标记换行
- 未开启 AI 断句时保持原有的文本框内强制换行逻辑

### 翻译文本清理优化
- 自动去除 BR 断句标记周围的多余空白，提升文本整洁度
- 未开启 AI 断句时，自动移除翻译结果中的 BR 标记，避免显示在最终结果中
- 渲染前统一处理 BR 标记：AI 断句开启时转换为换行符，关闭时移除标记

### 清理离线翻译器残余代码
- 清理了离线翻译器的残余引用和配置项
- 删除了 `offline` 翻译器枚举和相关逻辑
- 删除了 `--use-gpu-limited` 命令行参数
- 统一翻译器架构，仅保留在线翻译器：OpenAI、Gemini、Sakura 及其 HQ 版本

### 检测器优化
- 放宽了 YOLO 检测框替换主检测框的逻辑，提高检测准确性
- 优化了切割逻辑，改进文本区域分割算法

### 渲染修复
- 修复超大图片（如条漫）渲染崩溃问题：使用局部区域渲染绕过 OpenCV warpPerspective 的 32767 像素限制
- 改进字符缺失处理：字体中找不到的字符用 `?` 替代而非空格，便于发现问题
- 增加空渲染结果保护，防止零尺寸图层导致崩溃

- **行间距逻辑优化**：回退至基于间隙的计算方式，提升排版精确度，避免行间距过大

### 显存优化
- 在程序入口添加 `PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True` 环境变量，优化显存分配

### 快捷键增强
- **图片导航快捷键**：
  - **A**：切换到上一张图片
  - **D**：切换到下一张图片
  - 智能上下文识别：在输入框中输入文字时会自动输入字符，非输入状态下切换图片

- **编辑器工具快捷键更新**：
  - **导出图片**：`Ctrl+Q` (原 Ctrl+D)
  - **保存 JSON**：`Ctrl+W` (原 Ctrl+S)
  - **编辑原图**：`Ctrl+E` (新增)

- **保留的工具快捷键**：
  - **Q**：选择工具
  - **W**：画笔工具
  - **E**：橡皮擦工具

## ⚡ 优化

- 清理了翻译器相关代码，简化了架构

- 优化了内存占用，移除离线翻译器后减少了内存使用
- 更新了所有文档，移除离线翻译器说明
- 清理了界面和本地化文件中的离线翻译器选项

## 📝 迁移说明

如果之前使用离线翻译器，请改用在线翻译器：
- 推荐：OpenAI HQ 或 Gemini HQ（高质量）
- 备选：OpenAI、Gemini、Sakura

需要配置对应的 API Key，详见文档。

## 🔄 兼容性

- 配置文件中的离线翻译器选项需手动改为在线翻译器
- `use_gpu_limited` 配置项将被忽略
