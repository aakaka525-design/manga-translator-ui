# v1.9.9 更新日志

发布日期：2025-12-23

## ⚡ 优化

### OCR 模块优化
- **PaddleOCR 取色性能优化**：修复 PaddleOCR 颜色预测功能失效问题，改为批量处理方式（与 MangaOCR 一致），显著提升取色速度

### 超分模型优化
- **MangaJaNai 延迟加载优化**：优化模型加载策略，不再在初始化时预加载默认模型，而是在推理时根据图片类型（彩色/黑白）动态加载对应模型，避免同时加载多个模型导致显存溢出

### 依赖安装优化
- **优化 PyTorch 依赖源配置**：移除 requirements 文件中的 `--extra-index-url https://pypi.org/simple`，避免版本冲突
- **移除 xformers 版本限制**：将 `xformers==0.0.32.post2` 改为 `xformers`，允许安装最新兼容版本
- **移除 torchsummary 版本限制**：将 `torchsummary==1.5.1` 改为 `torchsummary`，修复该版本在 PyPI 上不存在导致的安装失败问题
- **修复 torchsummary 安装源问题**：在 launch.py 中添加排除列表，防止 torchsummary 被误判为 PyTorch 包而从 PyTorch CUDA 源安装（该源不包含此包），确保从 PyPI 镜像源正确安装
- **扩展 PyTorch 包识别列表**：在 launch.py 中扩展了 PyTorch 相关包的识别范围，确保所有 NVIDIA CUDA、Intel oneAPI 及 PyTorch 生态包都从正确的源（cu128）下载，包括：
  - PyTorch 核心包及变体（torch, torchvision, torchaudio, pytorch-triton 等）
  - NVIDIA CUDA 库（nvidia-cublas-cu12, nvidia-cudnn-cu12, nvidia-nccl-cu12 等）
  - Intel oneAPI 库（intel-openmp, oneccl, onemkl-sycl-* 等）
  - PyTorch 生态包（triton, fbgemm-gpu, vllm, flashinfer 等）

### 编辑器优化
- **创建统一的文件列表模型**：新增 `FileListModel` 类，自动识别原图、翻译后的图和未翻译的图，提供统一的加载接口

### 错误提示优化
- **优化常见错误提示**：为 AI 断句检查失败、翻译数量不匹配、翻译质量检查失败等错误添加"减小批量大小"解决方案
- **优化 404 错误提示**：添加翻译器类型匹配检查，说明 xxxx/v1 格式 API 应选择 OpenAI 翻译器
- **优化 429 错误提示**：详细列出 API 密钥错误、余额不足、速率超限、模型不支持等多种可能原因
- **优化网络连接错误匹配**：支持中文错误信息识别（"连接"、"超时"、"网络"）

### 并发流水线修复
- **修复修复线程无法正常退出的问题**：当图片没有检测到文本框时，修复线程卡住导致界面无响应

### 几何计算修复
- **修复 Shapely TopologyException 错误**：在 text_mask_utils.py 中添加几何体错误处理，当多边形交集计算失败时自动使用 buffer(0) 修复无效几何体，避免因文本框形状异常导致的 "side location conflict" 错误和程序崩溃

## 🐛 修复

### 超分模型修复
- **修复 MangaJaNai 模型切换显存问题**：修复在自动模式（x2/x4）下，从黑白图片切换到彩色图片时，旧模型未卸载导致显存占用过高的问题

### 上色模块修复
- **修复并行模式禁用时图片加载问题**：修复当用户启用并行模式但因特殊模式（如"仅上色"）导致并行被禁用时，系统未正确加载图片导致 `ctx.input` 为文件路径字符串而非 PIL Image 对象的问题（错误信息：`str object has no attribute 'convert'`）

### 编辑器修复
- **修复翻译完成后进入编辑器的问题**：翻译后的图片被错误识别为原图，自动加载 JSON 导致卡顿
- **修复点击"编辑原图"后删除文件画布未清空的问题**：删除文件时未检查关联的源文件路径
- **修复删除文件后自动加载下一张图片的问题**：删除文件后清除选择状态，避免触发自动加载
- **修复加载状态未清理导致下次加载失败的问题**：在清空编辑器状态时清理加载提示
- **修复中文路径图片加载失败问题**：使用 pathlib 替代 os.path 处理路径，改善对中文和特殊字符路径的支持
