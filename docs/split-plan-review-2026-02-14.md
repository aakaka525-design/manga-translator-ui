# gpu-translation-split-plan.md å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥äºº**: AI  
**æ—¥æœŸ**: 2026-02-14  
**å®¡æŸ¥èŒƒå›´**: æ–¹æ¡ˆæ–‡æ¡£ vs å®é™…ä»£ç  + è”è°ƒå®æµ‹æ•°æ®

---

## å¤æ ¸çŠ¶æ€æ›´æ–°ï¼ˆ2026-02-14 æ™šï¼‰

ä»¥ä¸‹æ¡ç›®åœ¨åç»­æ”¶æ•›ä¸­å·²å…³é—­æˆ–å·²ä¿®æ­£å£å¾„ï¼š

- å·²å…³é—­ï¼šæ–‡æ¡£â€œ82 åç«¯åè°ƒæœªå®ç°â€ç»“è®ºï¼ˆ`manga_translator/server/routes/v1_translate.py` å·²å®ç° split åè°ƒä¸ `Semaphore(1)` ä¸²è¡Œï¼‰ã€‚
- å·²å…³é—­ï¼š`TASK-SPLIT-008/009` çŠ¶æ€å†²çªï¼ˆæœ¬åœ°ç°åº¦ä¸è”è°ƒè¯æ®å·²åœ¨ worklog å®Œæˆæ”¶å£ï¼‰ã€‚
- å·²ä¿®æ­£ï¼š`/detect elapsed_ms` æ–‡æ¡£è¯­ä¹‰ï¼ˆæ”¹ä¸ºèšåˆå£å¾„ï¼Œ`ocr=null` + `mode=aggregated_detect_ocr`ï¼‰ã€‚
- å·²ä¿®æ­£ï¼š`/render` ä¸´æ—¶è¾“å‡ºè·¯å¾„å›ºå®š `/tmp/out*` é£é™©ï¼ˆæ”¹ä¸ºè¯·æ±‚çº§å”¯ä¸€è·¯å¾„ï¼‰ã€‚

å½“å‰ä»éœ€å¤–éƒ¨æ¡ä»¶å®Œæˆçš„é˜»å¡ï¼š

- CloudRun `GEMINI_API_KEY` è¢«å¹³å°åˆ¤å®š leakedï¼Œå¯¼è‡´ `x-fallback-used=1`ï¼›å¾…æ–° key è½®æ¢åå®Œæˆäº‘ç«¯ 10 é¡µç« èŠ‚éªŒæ”¶ã€‚

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ (æ•°æ®ä¸äº‹å®ä¸ç¬¦)

### 1. æ€§èƒ½ä¼°ç®—ä¸¥é‡åç¦»å®æµ‹

**æ–‡æ¡£å£°ç§° (Â§1, Â§2, Â§8)**:
- detect ~2s, render ~0.5s, GPU æ€»å ç”¨ ~2.5s/é¡µ
- GPU ååé‡æå‡ ~14x

**å®æµ‹æ•°æ® (2026-02-14 è”è°ƒ)**:

| å¹³å° | detect | render | GPU æ€»è®¡ |
|------|--------|--------|---------|
| PPIO 4090 | 10.3-13.3s | 11.2-14.1s | **21.5-27.3s** |
| Cloud Run L4 | 13.2-28.9s | 14.1-16.1s | **27.3s** |

**é—®é¢˜**: æ–¹æ¡ˆå†™çš„ "~2.5s/é¡µ" ä¸å®é™… "21-27s/é¡µ" å·® **10 å€**ã€‚åŸå› ï¼š
- æ–¹æ¡ˆä¸­ "detect 2s" æ¥è‡ªç¼“å­˜åçš„çƒ­çŠ¶æ€ä¼°ç®—ï¼Œé¦–æ¬¡æ£€æµ‹éœ€ GPU æ¨¡å‹æ¨ç†(ç›®æ ‡æ£€æµ‹+OCR)ï¼Œå®é™…çº¦ 10-28s
- æ–¹æ¡ˆä¸­ "render 0.5s" æ¥è‡ª context é˜¶æ®µçš„ render è€—æ—¶(104ms)ï¼Œä½† `_complete_translation_pipeline` åŒ…å« mask + inpaint + text_rendering å…¨æµç¨‹ï¼Œå®é™… 11-16s
- ååé‡æå‡ä¸æ˜¯ 14xï¼Œè€Œæ˜¯ **~1.5-1.7x** (41s unified â†’ 27s split)

**å»ºè®®**: ç”¨å®æµ‹æ•°æ®æ›¿æ¢æ‰€æœ‰ä¼°ç®—ï¼Œæ›´æ–° Â§1 çš„ç“¶é¢ˆåˆ†æï¼ˆ104ms render çš„å®šä¹‰éœ€æ˜ç¡®ï¼‰

---

### 2. Â§1 çš„ç“¶é¢ˆåˆ†æå¯èƒ½æœ‰è¯¯å¯¼æ€§

```
â”œâ”€ context é˜¶æ®µ (æ£€æµ‹+OCR+Gemini)  34,342ms  99.7%
â””â”€ render é˜¶æ®µ  (mask+inpaint+æ¸²æŸ“)    104ms   0.3%
```

**é—®é¢˜**: è¿™ç»™äººçš„å°è±¡æ˜¯ render åªéœ€ 104msã€‚ä½†å®é™…å®ç°ä¸­ `/render` è°ƒç”¨çš„æ˜¯ `_complete_translation_pipeline()`ï¼Œè¿™åŒ…å« masking + inpainting + text rendering å…¨æµç¨‹ï¼Œå®æµ‹ 11-16sã€‚

åŸå§‹ 104ms å¯èƒ½åªæ˜¯ `_complete_translation_pipeline` ä¸­çš„ text rendering å­æ­¥éª¤ï¼Œä¸åŒ…æ‹¬ mask å’Œ inpaintã€‚æ–¹æ¡ˆåŸºäºæ­¤æ•°æ®å¾—å‡º "render ~0.5s" çš„ä¼°ç®—æ˜¯é”™è¯¯çš„ã€‚

**å»ºè®®**: æ˜ç¡® 104ms æ˜¯å“ªä¸ªæ­¥éª¤çš„è€—æ—¶ï¼Œé‡æ–°åˆ†è§£ context é˜¶æ®µ 34,342ms ä¸­å±äº detect+OCR çš„éƒ¨åˆ† vs Gemini çš„éƒ¨åˆ†

---

## ğŸŸ¡ ä¸ä¸¥è°¨ (é€»è¾‘ç¼ºé™·æˆ–é—æ¼)

### 3. CtxCache æ–¹æ¡ˆ vs å®é™…å®ç°ä¸ä¸€è‡´

**æ–‡æ¡£ Â§4.1 (L274)**: `max_size=10`  
**å®é™…ä»£ç  (L84-86)**: `max_size=24`, ä¸”é€šè¿‡ç¯å¢ƒå˜é‡å¯é…ç½®

**æ–‡æ¡£ Â§4.1 (L313-320)**: `pop()` è¿”å› `Optional['Context']`  
**å®é™…ä»£ç  (L54-56)**: `pop()` è¿”å› `None` (æ— è¿”å›å€¼ï¼Œä»…åˆ é™¤)

**å»ºè®®**: æ–‡æ¡£ä¸­çš„ä¼ªä»£ç è¦ä¹ˆæ ‡æ³¨ä¸º"ç¤ºæ„"ï¼Œè¦ä¹ˆä¸ä»£ç åŒæ­¥

---

### 4. /render å¼‚å¸¸æ—¶çš„ cache æ³„æ¼é£é™©

**ä»£ç  (L2338-2343)**:
```python
try:
    output_bytes, render_result = await _split_render_payload(...)
except ValueError as exc:
    raise HTTPException(status_code=400, detail="RENDER_INPUT_INVALID") from exc
finally:
    _SPLIT_CTX_CACHE.pop(request.task_id)
```

**é—®é¢˜**: å¦‚æœ `_split_render_payload` æŠ›å‡ºçš„ä¸æ˜¯ `ValueError`ï¼ˆä¾‹å¦‚ `RuntimeError: render produced no output image`ï¼‰ï¼Œå¼‚å¸¸ä¼šè¢«å¤–å±‚çš„ FastAPI æ•è·ä¸º 500ï¼Œä½† `finally` ä»ç„¶ä¼š pop cacheã€‚è¿™æœ¬èº«æ²¡é—®é¢˜ã€‚

ä½†å¦‚æœåœ¨ **L2323-2335** èŒƒå›´å†…ï¼ˆcache get ä¹‹åã€render ä¹‹å‰ï¼‰å‘ç”Ÿå¼‚å¸¸ï¼Œæ­¤æ—¶è¿˜æ²¡è¿›å…¥ try-finallyï¼Œcache ä¸ä¼šè¢« pop â†’ **ctx æ³„æ¼ç›´åˆ° TTL è¿‡æœŸ**ã€‚

å…·ä½“åœºæ™¯: `RENDER_INPUT_INVALID`ï¼ˆregion_index è¶Šç•Œï¼‰æŠ›å‡º HTTPException 400 æ—¶ï¼Œcache ä¸ä¼šè¢«æ¸…ç†ã€‚

**é£é™©ç­‰çº§**: ä½ï¼ˆTTL ä¼šæœ€ç»ˆæ¸…ç†ï¼Œä½†å¦‚æœæ”»å‡»è€…åå¤ç”¨åŒä¸€ task_id å‘è¶Šç•Œè¯·æ±‚ï¼Œctx ä¼šä¸€ç›´å å†…å­˜ç›´åˆ° TTL 5 åˆ†é’Ÿåˆ°æœŸï¼‰

**å»ºè®®**: å°† cache pop ç§»åˆ°æ›´é å¤–çš„ finally ä¸­

---

### 5. ç¼“å­˜çš„æ˜¯æ•´ä¸ª dict è€Œé ctx å¯¹è±¡

**æ–‡æ¡£ Â§4.1**: ç¼“å­˜å†…å®¹æ˜¯ ctx å¯¹è±¡  
**å®é™…ä»£ç  (L732)**: ç¼“å­˜çš„æ˜¯ `raw` dictï¼ˆåŒ…å« `ctx`, `config`, `image_name`, `regions` ç­‰ï¼‰

**ä»£ç  (L2323)**:
```python
ctx_obj = (cache_payload or {}).get("ctx") if isinstance(cache_payload, dict) else None
```

**é—®é¢˜**: æ–‡æ¡£çš„ "ctx ç¼“å­˜" æè¿°ä¸å®é™…ç¼“å­˜ dict(å« config + ctx) ä¸ä¸€è‡´ã€‚è¿™ä¸å½±å“åŠŸèƒ½ï¼Œä½†ä¼šè¯¯å¯¼æ’éšœã€‚

---

### 6. å¹¶å‘æ¨¡å‹æè¿°ä¸å®é™…ä¸ç¬¦

**æ–‡æ¡£ Â§5 (L370-373)**:
```
GPU Worker:   [detect_1 2s][idle 30s][render_1 0.5s][detect_2 2s]...
82 åç«¯:       [          gemini_1 30s          ]
```

**å®æµ‹**: GPU Worker ä¸Š detect å ç”¨ 10-28sï¼Œrender å ç”¨ 11-16sã€‚è¿™æ„å‘³ç€ï¼š
- GPU åœ¨ detect+render æœŸé—´ä¸æ˜¯ "idle"
- åˆ†ç¦»æ¨¡å¼çš„çœŸå®æ—¶åºæ˜¯:

```
GPU:    [detect_1 13s][idle ~30s gemini][render_1 14s][detect_2 13s]...
82åç«¯:                [   gemini_1 30s  ]
```

è¿™é‡Œæœ‰ä¸€ä¸ªå…³é”®é—®é¢˜: **Gemini è€—æ—¶ï¼ˆ30sï¼‰å’Œ detect è€—æ—¶ï¼ˆ13sï¼‰é‡çº§æ¥è¿‘**ï¼ŒGPU çš„"ç©ºé—²"æ¯”ä¾‹æ²¡æœ‰æ–¹æ¡ˆé¢„æœŸé‚£ä¹ˆé«˜ã€‚

**å®æµ‹æ”¶ç›Š**: split æ€»è€—æ—¶ 27s vs unified 41s = **çœ 34%**ï¼ˆè€Œéæ–¹æ¡ˆé¢„æœŸçš„ 93%ï¼‰

---

### 7. Cloud Run éƒ¨ç½²ä¿¡æ¯é—æ¼

æ–‡æ¡£åªæåˆ° PPIO éƒ¨ç½²ï¼Œå®Œå…¨æ²¡æœ‰ Cloud Run éƒ¨ç½²ã€‚ä»Šå¤©å·²åœ¨ Cloud Run (`main1-487412`, `europe-west1`, L4 GPU) éƒ¨ç½²å¹¶æµ‹è¯•é€šè¿‡ï¼Œä½†æ–‡æ¡£æœªè®°å½•ã€‚

---

## ğŸŸ¢ è¡¨è¿°ä¸æ¸…æ¥š (å»ºè®®æ”¹è¿›)

### 8. "åˆ†ç¦»æ¨¡å¼" é»˜è®¤å€¼ä¸æ˜ç¡®

**æ–‡æ¡£ Â§7 (å®æ–½çŠ¶æ€æ›´æ–°)**:
> `translate_pipeline_mode=unified|split`ï¼ˆé»˜è®¤ unifiedï¼Œæ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–ï¼‰

**é—®é¢˜**: æ²¡è¯´æ˜åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹åˆ‡æ¢åˆ° splitã€‚æ˜¯ç”¨æˆ·æ‰‹åŠ¨ï¼Ÿè¿˜æ˜¯è‡ªåŠ¨ï¼Ÿè¿˜æ˜¯ A/B æµ‹è¯•ï¼Ÿé»˜è®¤ unified æ„å‘³ç€æ‰€æœ‰å®é™…æµé‡éƒ½èµ°æ—§è·¯å¾„ï¼Œsplit è·¯å¾„å½¢åŒè™šè®¾ã€‚

**å»ºè®®**: æ˜ç¡® split çš„å¯ç”¨ç­–ç•¥å’Œç°åº¦è®¡åˆ’

---

### 9. 82 åç«¯åè°ƒé€»è¾‘ (Â§3.2) æ˜¯ä¼ªä»£ç , æœªå®ç°

æ–‡æ¡£ Â§3.2 åŒ…å«å¤§é‡ 82 åç«¯åè°ƒä¼ªä»£ç  (`split_pipeline_translate`)ï¼Œä½†ï¼š
- å½“å‰æ‰€æœ‰ split ä»£ç éƒ½åœ¨ GPU Worker å†…éƒ¨ï¼ˆ`v1_translate.py`ï¼‰
- 82 åç«¯å®é™…å¦‚ä½•è°ƒåº¦ detect â†’ translate â†’ render **æ²¡æœ‰ä»£ç å®ç°**
- `_translate_texts_for_split` å®é™…åœ¨ GPU Worker ä¸Šè¿è¡Œç¿»è¯‘ï¼Œå¹¶é"82åç«¯æœ¬åœ°ç¿»è¯‘"

**é—®é¢˜**: æ–¹æ¡ˆæè¿°çš„"Gemini è°ƒç”¨ä» GPU Worker å‰¥ç¦»åˆ° 82 åç«¯"è¿™ä¸€æ ¸å¿ƒæ¶æ„ **å®é™…ä¸Šæ²¡æœ‰å®ç°**ã€‚å½“å‰å®ç°åªæ˜¯åœ¨ GPU Worker ä¸Šå¢åŠ äº† detect/render çš„ç«¯ç‚¹æ‹†åˆ†ï¼Œç¿»è¯‘ä»åœ¨ GPU Worker ä¸Šå‘ç”Ÿã€‚

**è¿™æ˜¯æ–¹æ¡ˆæœ€å¤§çš„æœªå®Œæˆé¡¹ã€‚**

---

### 10. `/detect` çš„ elapsed_ms ä¸­ ocr å§‹ç»ˆä¸º 0

**ä»£ç  (L586-590)**:
```python
"elapsed_ms": {
    "detect": round(total_ms, 3),
    "ocr": 0.0,
    "total": round(total_ms, 3),
}
```

OCR æ—¶é—´æœªç‹¬ç«‹æµ‹é‡ï¼Œå§‹ç»ˆä¸º 0ã€‚detect çš„ total åŒ…å«äº† detect + OCR çš„æ€»æ—¶é—´ã€‚æ–¹æ¡ˆæ–‡æ¡£ Â§6 çš„å¯è§‚æµ‹æ€§è¦æ±‚ `x-stage-elapsed-ms: {"detect":N,"ocr":N}` æ— æ³•æ»¡è¶³å®é™…åˆ†ç¦»åº¦é‡ã€‚

---

### 11. `/render` è¾“å‡ºè·¯å¾„ç¡¬ç¼–ç 

**ä»£ç  (L695)**:
```python
target_path = Path(f"/tmp/out{suffix}")
```

å¹¶å‘è¯·æ±‚æ—¶ï¼ˆå³ä½¿ concurrency=1ï¼Œæœªæ¥å¯èƒ½è°ƒæ•´ï¼‰ï¼Œå¤šä¸ª render ä¼šå†™åŒä¸€ä¸ª `/tmp/out.jpg` æ–‡ä»¶ï¼Œè™½ç„¶å®é™… `_prepare_output_image` å¯èƒ½ä¸ä¾èµ–ç£ç›˜å†™å…¥ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªä»£ç æ°”å‘³ã€‚

---

## ğŸ“Š å®¡æŸ¥æ±‡æ€»

| ä¼˜å…ˆçº§ | é—®é¢˜æ•° | è¦ç‚¹ |
|:------:|:------:|------|
| ğŸ”´ ä¸¥é‡ | 2 | æ€§èƒ½æ•°æ®åç¦» 10 å€ï¼›render è€—æ—¶åˆ†ææœ‰è¯¯ |
| ğŸŸ¡ ä¸ä¸¥è°¨ | 5 | cache å®ç°ä¸ä¸€è‡´ï¼›å¹¶å‘æ¨¡å‹æè¿°å¤±çœŸï¼›**82 åç«¯åè°ƒæœªå®ç°** |
| ğŸŸ¢ ä¸æ¸…æ¥š | 4 | split å¯ç”¨ç­–ç•¥ï¼›OCR åº¦é‡ç¼ºå¤±ï¼›Cloud Run éƒ¨ç½²ç¼ºå¤± |

### å»ºè®®ä¿®å¤ä¼˜å…ˆçº§

1. **[P0]** ç”¨å®æµ‹æ•°æ®æ›¿æ¢æ‰€æœ‰ "~2.5s/é¡µ" "~14x" ä¼°ç®—
2. **[P0]** æ˜ç¡® Â§9 çš„æœªå®Œæˆé¡¹: 82 åç«¯åè°ƒé€»è¾‘ï¼ˆè¿™æ˜¯åˆ†ç¦»æ–¹æ¡ˆçš„æ ¸å¿ƒä»·å€¼ï¼‰
3. **[P1]** è¿½åŠ  Cloud Run éƒ¨ç½²é…ç½®è®°å½•
4. **[P1]** ç»Ÿä¸€ CtxCache æ–‡æ¡£ä¸ä»£ç 
5. **[P2]** ä¿®å¤ /render ä¸­ RENDER_INPUT_INVALID çš„ cache æ³„æ¼
6. **[P2]** render è¾“å‡ºè·¯å¾„é¿å…ç¡¬ç¼–ç 
